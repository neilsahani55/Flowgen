{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Page Data Maker - Flowgen{% endblock %}

{% block page_title %}
<h1>Page Data Maker</h1>
<p class="text-muted">Update your website information and see formatted markdown response</p>
{% endblock %}

{% block extra_css %}
<style>
    .page-data-maker-container {
        width: 100%;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(66, 98, 237, 0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .pdm-header {
        background: linear-gradient(135deg, #4262ed, #5a7cff);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .pdm-header h2 {
        font-size: 2.2rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: white;
    }

    .pdm-header h2 i {
        font-size: 2rem;
    }

    .pdm-header p {
        opacity: 0.9;
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .pdm-content {
        display: flex;
        flex-direction: column;
        /* ?? vertical */
        gap: 30px;
        /* spacing between sections */
    }


    .left-panel {
        flex: 1;
        min-width: 350px;
        padding: 40px;
        border-right: 1px solid #e2e8f0;
    }

    .right-panel {
        flex: 1;
        min-width: 350px;
        padding: 40px;
        background-color: #f9fafb;
        overflow-y: auto;
        max-height: 800px;
    }

    .form-group {
        margin-bottom: 30px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2d3748;
        font-size: 1.1rem;
    }

    .pdm-form-control {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s;
        background-color: #f8fafc;
    }

    .pdm-form-control:focus {
        outline: none;
        border-color: #4262ed;
        box-shadow: 0 0 0 3px rgba(66, 98, 237, 0.2);
        background-color: white;
    }

    .pdm-form-control.description {
        min-height: 150px;
        resize: vertical;
    }

    .char-count {
        text-align: right;
        font-size: 0.9rem;
        color: #718096;
        margin-top: 6px;
        transition: color 0.3s;
    }

    .char-count.warning {
        color: #ed8936;
    }

    .char-count.danger {
        color: #e53e3e;
    }

    .input-helper {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .input-helper i {
        font-size: 0.8rem;
    }

    .validation-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .validation-icon.show {
        opacity: 1;
    }

    .validation-icon.valid {
        color: #38a169;
    }

    .validation-icon.invalid {
        color: #e53e3e;
    }

    .input-wrapper {
        position: relative;
    }

    .input-wrapper .pdm-form-control {
        padding-right: 45px;
    }

    .keyboard-hint {
        font-size: 0.8rem;
        color: #a0aec0;
        text-align: center;
        margin-top: 15px;
    }

    .keyboard-hint kbd {
        background-color: #edf2f7;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 2px 6px;
        font-family: inherit;
        font-size: 0.75rem;
    }

    .submit-btn {
        background: linear-gradient(135deg, #4262ed, #5a7cff);
        color: white;
        border: none;
        padding: 18px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        letter-spacing: 0.5px;
        margin-top: 10px;
    }

    .submit-btn:hover {
        background: linear-gradient(135deg, #3a57d9, #4a6cf7);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(66, 98, 237, 0.3);
    }

    .submit-btn:active {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .response-message {
        margin-top: 25px;
        padding: 18px;
        border-radius: 10px;
        text-align: center;
        font-weight: 600;
        display: none;
    }

    .response-message.success {
        background-color: #f0fff4;
        color: #2f855a;
        border: 1px solid #c6f6d5;
        display: block;
    }

    .response-message.error {
        background-color: #fff5f5;
        color: #c53030;
        border: 1px solid #fed7d7;
        display: block;
    }

    .response-preview {
        margin-top: 20px;
    }

    .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .response-header h3 {
        color: #4262ed;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.5rem;
    }

    .response-actions {
        display: flex;
        gap: 10px;
    }

    .action-btn {
        background-color: #edf2f7;
        border: 1px solid #e2e8f0;
        color: #4a5568;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .action-btn:hover {
        background-color: #e2e8f0;
        color: #2d3748;
    }

    .action-btn:active {
        transform: scale(0.98);
    }

    .action-btn.copied {
        background-color: #c6f6d5;
        color: #2f855a;
        border-color: #9ae6b4;
    }

    .retry-btn {
        background: linear-gradient(135deg, #ed8936, #f6ad55);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }

    .retry-btn:hover {
        background: linear-gradient(135deg, #dd6b20, #ed8936);
        transform: translateY(-2px);
    }

    .markdown-preview {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 25px;
        height: 600px;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        line-height: 1.6;
    }

    /* Markdown styling */
    .markdown-preview h1,
    .markdown-preview h2,
    .markdown-preview h3,
    .markdown-preview h4 {
        margin-top: 1.5em;
        margin-bottom: 0.8em;
        color: #1a202c;
        font-weight: 600;
    }

    .markdown-preview h2 {
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.3em;
        color: #4262ed;
    }

    .markdown-preview h3 {
        color: #2d3748;
    }

    .markdown-preview p {
        margin-bottom: 1.2em;
    }

    .markdown-preview ul,
    .markdown-preview ol {
        margin-bottom: 1.2em;
        padding-left: 2em;
    }

    .markdown-preview li {
        margin-bottom: 0.5em;
    }

    .markdown-preview ul li {
        list-style-type: disc;
    }

    .markdown-preview strong {
        font-weight: 700;
        color: #2d3748;
    }

    .markdown-preview em {
        font-style: italic;
    }

    .markdown-preview code {
        background-color: #f7fafc;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: #e53e3e;
    }

    .markdown-preview blockquote {
        border-left: 4px solid #4262ed;
        padding-left: 1em;
        margin-left: 0;
        color: #4a5568;
        font-style: italic;
    }

    .markdown-preview a {
        color: #4262ed;
        text-decoration: none;
        font-weight: 500;
    }

    .markdown-preview a:hover {
        text-decoration: underline;
    }

    .markdown-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #a0aec0;
        text-align: center;
        padding: 40px;
    }

    .markdown-placeholder i {
        font-size: 3rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .markdown-placeholder h3 {
        color: #718096;
        margin-bottom: 10px;
    }

    .markdown-placeholder p {
        max-width: 400px;
    }

    @media (max-width: 900px) {
        .pdm-content {
            flex-direction: column;
        }

        .left-panel,
        .right-panel {
            border-right: none;
            border-bottom: 1px solid #e2e8f0;
        }

        .markdown-preview {
            height: 500px;
        }
    }

    @media (max-width: 768px) {

        .left-panel,
        .right-panel {
            padding: 30px 25px;
        }

        .pdm-header {
            padding: 25px 20px;
        }

        .pdm-header h2 {
            font-size: 1.8rem;
        }
    }

    @media (max-width: 480px) {

        .left-panel,
        .right-panel {
            padding: 25px 20px;
        }

        .pdm-form-control {
            padding: 14px 16px;
        }

        .response-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-data-maker-container">
            <div class="pdm-header">
                <h2><i class="fas fa-edit"></i> Page Data Maker</h2>
                <p>Update your website information and see formatted markdown response</p>
            </div>

            <div class="pdm-content">
                <div class="left-panel">
                    <form id="dataForm">
                        <div class="form-group">
                            <label for="websiteUrl"><i class="fas fa-globe"></i> Website URL</label>
                            <div class="input-wrapper">
                                <input type="url" id="websiteUrl" class="pdm-form-control"
                                    placeholder="https://example.com" required autofocus>
                                <i class="fas fa-check-circle validation-icon" id="urlValidation"></i>
                            </div>
                            <div class="input-helper">
                                <i class="fas fa-info-circle"></i>
                                <span>Enter complete URL including https://</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="companyName"><i class="fas fa-building"></i> Company Name</label>
                            <div class="input-wrapper">
                                <input type="text" id="companyName" class="pdm-form-control"
                                    placeholder="Enter your company name" required maxlength="100">
                                <i class="fas fa-check-circle validation-icon" id="nameValidation"></i>
                            </div>
                            <div class="input-helper">
                                <i class="fas fa-info-circle"></i>
                                <span id="nameCharCount">0</span>/100 characters
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="companyDescription"><i class="fas fa-align-left"></i> Company
                                Description</label>
                            <textarea id="companyDescription" class="pdm-form-control description"
                                placeholder="Describe your company's mission, products, or services..." required
                                maxlength="2000"></textarea>
                            <div class="char-count" id="charCountWrapper">
                                <span id="charCount">0</span>/2000 characters
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Update Page Data
                        </button>

                        <div class="keyboard-hint">
                            <kbd>Ctrl</kbd> + <kbd>Enter</kbd> to submit
                        </div>

                        <div id="responseMessage" class="response-message"></div>
                    </form>
                </div>

                <div class="right-panel">
                    <div class="response-preview">
                        <div class="response-header">
                            <h3><i class="fas fa-code"></i> Response Preview (Markdown)</h3>
                            <div class="response-actions">
                                <button type="button" class="action-btn" id="copyBtn" title="Copy to clipboard"
                                    disabled>
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button type="button" class="action-btn" id="clearBtn" title="Clear response">
                                    <i class="fas fa-trash-alt"></i> Clear
                                </button>
                            </div>
                        </div>

                        <div class="markdown-preview" id="markdownPreview">
                            <div class="markdown-placeholder">
                                <i class="fas fa-file-alt"></i>
                                <h3>No Response Yet</h3>
                                <p>Submit your data to see the formatted markdown response.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elements
    const form = document.getElementById('dataForm');
    const websiteUrlInput = document.getElementById('websiteUrl');
    const companyNameInput = document.getElementById('companyName');
    const companyDescriptionInput = document.getElementById('companyDescription');
    const charCountElement = document.getElementById('charCount');
    const charCountWrapper = document.getElementById('charCountWrapper');
    const nameCharCount = document.getElementById('nameCharCount');
    const submitBtn = document.getElementById('submitBtn');
    const responseMessage = document.getElementById('responseMessage');
    const markdownPreview = document.getElementById('markdownPreview');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const urlValidation = document.getElementById('urlValidation');
    const nameValidation = document.getElementById('nameValidation');

    // Webhook URL
    const WEBHOOK_URL = 'https://mcmflow.app.n8n.cloud/webhook/c9db4311-9926-4e7c-b8d7-a152a4de9033';

    // LocalStorage key for form persistence
    const STORAGE_KEY = 'pageDataMaker_formData';

    // Current response data for copy functionality
    let currentMarkdownResponse = '';

    // ===== FORM PERSISTENCE =====
    function saveFormData() {
        const formData = {
            websiteUrl: websiteUrlInput.value,
            companyName: companyNameInput.value,
            companyDescription: companyDescriptionInput.value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    function loadFormData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const formData = JSON.parse(savedData);
                websiteUrlInput.value = formData.websiteUrl || '';
                companyNameInput.value = formData.companyName || '';
                companyDescriptionInput.value = formData.companyDescription || '';
                updateAllValidations();
            } catch (e) {
                console.warn('Failed to load saved form data:', e);
            }
        }
    }

    function clearFormData() {
        localStorage.removeItem(STORAGE_KEY);
    }

    // ===== VALIDATION FUNCTIONS =====
    function isValidUrl(string) {
        try {
            const url = new URL(string);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (_) {
            return false;
        }
    }

    function updateUrlValidation() {
        const value = websiteUrlInput.value.trim();
        if (value.length === 0) {
            urlValidation.classList.remove('show', 'valid', 'invalid');
        } else if (isValidUrl(value)) {
            urlValidation.classList.add('show', 'valid');
            urlValidation.classList.remove('invalid');
            urlValidation.className = 'fas fa-check-circle validation-icon show valid';
        } else {
            urlValidation.classList.add('show', 'invalid');
            urlValidation.classList.remove('valid');
            urlValidation.className = 'fas fa-times-circle validation-icon show invalid';
        }
    }

    function updateNameValidation() {
        const value = companyNameInput.value.trim();
        nameCharCount.textContent = value.length;
        if (value.length === 0) {
            nameValidation.classList.remove('show', 'valid', 'invalid');
        } else if (value.length >= 2) {
            nameValidation.classList.add('show', 'valid');
            nameValidation.classList.remove('invalid');
            nameValidation.className = 'fas fa-check-circle validation-icon show valid';
        } else {
            nameValidation.classList.add('show', 'invalid');
            nameValidation.classList.remove('valid');
            nameValidation.className = 'fas fa-times-circle validation-icon show invalid';
        }
    }

    function updateDescriptionCharCount() {
        const length = companyDescriptionInput.value.length;
        charCountElement.textContent = length;

        // Update color based on length
        charCountWrapper.classList.remove('warning', 'danger');
        if (length >= 1800) {
            charCountWrapper.classList.add('danger');
        } else if (length >= 1500) {
            charCountWrapper.classList.add('warning');
        }
    }

    function updateAllValidations() {
        updateUrlValidation();
        updateNameValidation();
        updateDescriptionCharCount();
    }

    // ===== EVENT LISTENERS FOR VALIDATION =====
    websiteUrlInput.addEventListener('input', function () {
        updateUrlValidation();
        saveFormData();
    });

    companyNameInput.addEventListener('input', function () {
        updateNameValidation();
        saveFormData();
    });

    companyDescriptionInput.addEventListener('input', function () {
        updateDescriptionCharCount();
        saveFormData();
    });

    // ===== KEYBOARD SHORTCUT (Ctrl+Enter to submit) =====
    document.addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            if (!submitBtn.disabled) {
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        }
    });

    // ===== COPY TO CLIPBOARD =====
    copyBtn.addEventListener('click', async function () {
        if (!currentMarkdownResponse) return;

        try {
            await navigator.clipboard.writeText(currentMarkdownResponse);
            copyBtn.classList.add('copied');
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';

            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            }, 2000);
        } catch (err) {
            console.error('Failed to copy:', err);
            showMessage('Failed to copy to clipboard', 'error');
        }
    });

    // ===== CLEAR RESPONSE =====
    clearBtn.addEventListener('click', function () {
        currentMarkdownResponse = '';
        copyBtn.disabled = true;
        markdownPreview.innerHTML = `
            <div class="markdown-placeholder">
                <i class="fas fa-file-alt"></i>
                <h3>No Response Yet</h3>
                <p>Submit your data to see the formatted markdown response.</p>
            </div>
        `;
    });

    // Initialize on page load
    loadFormData();
    updateAllValidations();

    // Function to render markdown to HTML
    function renderMarkdown(markdownText) {
        // Simple markdown to HTML converter
        let html = markdownText;

        // Convert headers
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

        // Convert bold text
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Convert italic text
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

        // Convert unordered list items
        html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');

        // Wrap consecutive list items in ul tags
        html = html.replace(/(<li>.*<\/li>)/gims, function (match) {
            return '<ul>' + match + '</ul>';
        });

        // Convert line breaks to paragraphs
        html = html.replace(/\n\n/g, '</p><p>');
        html = '<p>' + html + '</p>';

        // Fix nested lists
        html = html.replace(/<ul>\s*<li>(.*:)<\/li>\s*<ul>/gim, '<ul><li>$1<ul>');
        html = html.replace(/<\/ul>\s*<\/ul>/gim, '</ul></li></ul>');

        // Convert links (simple pattern)
        html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');

        return html;
    }

    // Function to display markdown response
    function displayMarkdownResponse(responseData) {
        if (responseData && responseData.length > 0 && responseData[0].text) {
            const markdownText = responseData[0].text;
            currentMarkdownResponse = markdownText;
            const htmlContent = renderMarkdown(markdownText);

            markdownPreview.innerHTML = htmlContent;
            markdownPreview.scrollTop = 0;
            copyBtn.disabled = false;
        } else {
            currentMarkdownResponse = '';
            copyBtn.disabled = true;
            markdownPreview.innerHTML = `
                <div class="markdown-placeholder">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Invalid Response Format</h3>
                    <p>The response doesn't contain valid markdown data in the expected format.</p>
                </div>
            `;
        }
    }

    // Handle form submission
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Get form values
        const websiteUrl = websiteUrlInput.value.trim();
        const companyName = companyNameInput.value.trim();
        const companyDescription = companyDescriptionInput.value.trim();

        // Basic validation
        if (!websiteUrl || !companyName || !companyDescription) {
            showMessage('Please fill in all fields', 'error');
            return;
        }

        // Validate URL format
        try {
            new URL(websiteUrl);
        } catch (error) {
            showMessage('Please enter a valid website URL (including https://)', 'error');
            return;
        }

        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Data...';

        // Prepare data for webhook
        const data = {
            websiteUrl,
            companyName,
            companyDescription,
            timestamp: new Date().toISOString(),
            source: 'Page Data Maker'
        };

        try {
            // Send data to webhook
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // Check if request was successful
            if (response.ok) {
                try {
                    // Try to parse the response as JSON
                    const responseData = await response.json();

                    // Display the actual webhook response
                    displayMarkdownResponse(responseData);
                    showMessage('Data successfully sent! Response displayed.', 'success');
                    clearFormData(); // Clear saved data on success
                } catch (jsonError) {
                    // If response is not JSON, show error
                    currentMarkdownResponse = '';
                    copyBtn.disabled = true;
                    markdownPreview.innerHTML = `
                        <div class="markdown-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Response Format Error</h3>
                            <p>The response is not in valid JSON format.</p>
                        </div>
                    `;
                    showMessage('Data sent but response is not in expected format.', 'error');
                }

                // Reset form after successful submission
                form.reset();
                charCountElement.textContent = 0;
                nameCharCount.textContent = 0;
                updateAllValidations();
            } else {
                throw new Error(`Server responded with status: ${response.status}`);
            }

        } catch (error) {
            console.error('Error sending data:', error);
            showMessage(`Failed to send data: ${error.message}`, 'error');

            currentMarkdownResponse = '';
            copyBtn.disabled = true;

            // Show error in preview panel with retry button
            markdownPreview.innerHTML = `
                <div class="markdown-placeholder">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Connection Error</h3>
                    <p>Unable to connect to the server. Please check your connection and try again.</p>
                    <button type="button" class="retry-btn" onclick="document.getElementById('submitBtn').click();">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Update Page Data';
        }
    });

    // Function to show response message
    function showMessage(message, type) {
        responseMessage.textContent = message;
        responseMessage.className = 'response-message ' + type;
        responseMessage.style.display = 'block';

        // Hide message after 5 seconds
        setTimeout(() => {
            responseMessage.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}